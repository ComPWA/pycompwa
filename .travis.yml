language: cpp
os: linux
dist: bionic # default

branches:
  only:
    - master
    - /\d+\.\d+.*/ # Run on tags e.g. 0.1.2
  except: gh-pages

env:
  global:
    - OMP_NUM_THREADS: 1
    - LANG: en_US.UTF-8
    - BASEPATH: "$TRAVIS_BUILD_DIR"
    - ROOTSYS: "$BASEPATH/root"

addons:
  homebrew:
    packages:
      - boost
      - python3
      - pip3
  apt:
    update: true
    packages:
      - libboost-all-dev
      - python3
      - python3-pip
      - python3-venv
      - pandoc

before_install: # activate virtual environment
  - cd $BASEPATH
  - python3 -m venv venv
  - source ./venv/bin/activate

install: # install dependencies
  - python3 -m pip install scikit-build
  - python3 -m pip install -r tests/requirements.txt
  - wget https://root.cern.ch/download/root_${ROOTBIN}.tar.gz
  - tar xpvfz root_*.tar.gz > /dev/null 2>&1
  - source root/bin/thisroot.sh

before_script: # build the project
  - cd $BASEPATH
  - python3 setup.py  --generator "Unix Makefiles" --skip-generator-test install -- -- -j2

jobs:
  include:
    - name: Test XCode build
      os: osx
      osx_image: xcode10.2
      env:
        - TASK="clang, ROOT v6.18"
        - ROOTBIN="v6.18.04.macosx64-10.14-clang100"
      script:
        - echo "The tests can't run on mac osx because of a wrong RPATH in the precompiled root binaries"

    - name: Test gcc build (Linux)
      os: linux
      dist: bionic
      compiler: gcc
      env:
        - TASK="gcc7, ROOT v6.18"
        - ROOTBIN="v6.18.04.Linux-ubuntu18-x86_64-gcc7.4"
      script:
        - cd $BASEPATH/tests
        - python -m pytest

    - name: Test and deploy documentation
      os: linux
      dist: bionic
      compiler: gcc
      env:
        - TASK="test and deploy documentation"
        - ROOTBIN="v6.18.04.Linux-ubuntu18-x86_64-gcc7.4"
      install:
        - wget https://root.cern.ch/download/root_${ROOTBIN}.tar.gz
        - tar xpvfz root_*.tar.gz > /dev/null 2>&1
        - source root/bin/thisroot.sh
        - cd $BASEPATH
        - python3 -m pip install -r requirements.txt
        - python3 -m pip install -r doc/requirements.txt
        - python3 -m pip install virtualenvwrapper
      before_script: echo "Running developer mode installation"
      script: # developer mode build
        - cd $BASEPATH
        - source venv/bin/virtualenvwrapper.sh
        - add2virtualenv $BASEPATH
        - mkdir build
        - cd build
        - cmake .. -DUSE_GENEVA=OFF -DPYTHON_EXECUTABLE=$(which python)
        - make -j2
        - cd $BASEPATH/pycompwa
        - ln -s ../build/ui*.so
        - cd $BASEPATH/doc
        - make linkcheck
        - NBSPHINX_EXECUTE='' make html
      before_deploy:
        - cd $BASEPATH
        - openssl aes-256-cbc -K $encrypted_ffa3dff63372_key -iv $encrypted_ffa3dff63372_iv -in github_deploy_key.enc -out github_deploy_key -d
      deploy:
        strategy: git # default
        provider: pages
        keep_history: true
        deploy_key: github_deploy_key
        cleanup: false
        edge: true
        repo: ComPWA/ComPWA.github.io
        target_branch: master
        local_dir: "$BASEPATH/doc/build/html"
        verbose: true
        on:
          branch: master

    - name: test clang build (Linux) + code coverage
      os: linux
      dist: bionic
      compiler: clang
      env:
        - TASK="clang, ROOT v6.18 + code coverage"
        - ROOTBIN="v6.18.04.Linux-ubuntu18-x86_64-gcc7.4"
      script:
        - cd $BASEPATH/tests
        - python -m pytest
      after_success:
        - python3 -m pip install codecov
        - python3 -m codecov

    - name: Deploy PyPI package
      os: linux
      dist: bionic
      env:
        - TASK="deployment"
      install: echo "Skipping install stage!"
      script: echo "Skipping script stage!"
      before_script: echo "Skipping before_script stage!"
      before_deploy:
        - pip install scikit-build
        - pip install twine
      deploy:
        edge: true
        provider: pypi
        on:
          tags: true
        distributions: sdist
        skip_existing: true
        user: __token__
        password:
          secure: akD5cYCgdQV1jCMQwzP4zvcEW7OYqL/R2CHMTP5Z3X4hhro5ei5uahjBRCcM4MpQucrRgrLAMKCCmGhmdf7qS0URXzQu8J5tPxVc0pmiczkveIIRTp79OAjDjzcMAxIQbPturBbR5UfOLrzlREMa3ZuUx2JqlEPZAt2siJDbTbi71yhWyGLyxqTqOjcvmYstcZP/IXMs7euen8/kDpgpm/mY/JcBH7XisLV2Yz5KjiHHcLapzg1JVPypxib9pd+gbTRaAzeL4pwrwGtGYNluux/CBLJcYZmDb7dHdcE49ln+Cq5BJPem9uZo0XKcNrnnzmIFMPaJ/zhVxxbLLMJ2EfAcPvnzY9hxtMSMftv2J8WCqu46kL11kHHA6620CMls2iX8tNomq3wV8hbuk1ETb7mrs0/5wVLinkSyEO5MurjaB/1gAC/0BWyRJ4vxckMHQptXowl0RYL0fHPbstRWmDYoBZQMHEfcwLoOapgb9oQaK0QncXbPkw+JnjNeRBwScp6wbSxrsPiw+agJgyNHAmfgrqpteZHqd6WJt+7+JzH9tr0UfcPg9xuMC69VonatrwSceRkvDLCr7u2HMAakitcVmbxKfpptBtC2ja62iocldhXV7ysSrRltyepcxLP3Ilpl2l+nWyzmCDbTaPYJgM41qIoYvaAKuBQJ61PZ6yo=
